require 'minitest/autorun'
require 'debug'
load '../postprocess.rb'

class APITest < Minitest::Test
    def test_where
      puts 'test_where!'
      trace = {"x":[0,4e-12,8e-12,1.6e-11,3.2e-11,6.4e-11,1.28e-10,2.56e-10,4.854261e-10,5e-10,5.051184e-10,5.153552e-10,5.358289e-10,5.767762e-10,6.362661e-10,7.305453e-10,9.191037e-10,1.29622e-9,2.050454e-9,2.850454e-9,3.650454e-9,4.450454e-9,5.250454e-9,5.5e-9,5.55e-9,5.65e-9,5.85e-9,6e-9,6.021919e-9,6.065758e-9,6.153435e-9,6.328789e-9,6.63203e-9,7.238512e-9,8.038512e-9,8.838512e-9,9.638512e-9,1e-8,1.005e-8,1.015e-8,1.035e-8,1.05e-8,1.05276e-8,1.058279e-8,1.069318e-8,1.091396e-8,1.1e-8,1.104416e-8,1.113247e-8,1.129529e-8,1.162094e-8,1.221654e-8,1.301654e-8,1.381654e-8,1.461654e-8,1.541654e-8,1.55e-8,1.552791e-8,1.558373e-8,1.569536e-8,1.587282e-8,1.6e-8,1.601908e-8,1.605725e-8,1.613359e-8,1.62622e-8,1.644614e-8,1.665214e-8,1.696426e-8,1.747919e-8,1.827919e-8,1.907919e-8,1.987919e-8,2e-8,2.002447e-8,2.007341e-8,2.01713e-8,2.030458e-8,2.046508e-8,2.05e-8,2.050783e-8,2.05235e-8,2.055484e-8,2.061751e-8,2.073087e-8,2.095757e-8,2.141099e-8,2.221099e-8,2.301099e-8,2.381099e-8,2.461099e-8,2.541099e-8,2.55e-8,2.553109e-8,2.559328e-8,2.571764e-8,2.596638e-8,2.6e-8,2.601513e-8,2.604538e-8,2.610589e-8,2.622691e-8,2.644804e-8,2.689031e-8,2.769031e-8,2.849031e-8,2.929031e-8,3e-8,3.005e-8,3.015e-8,3.035e-8,3.05e-8,3.052755e-8,3.058265e-8,3.069284e-8,3.091323e-8,3.1e-8,3.104408e-8,3.113223e-8,3.129572e-8,3.16227e-8,3.221819e-8,3.301819e-8,3.381819e-8,3.461819e-8,3.541819e-8,3.55e-8,3.553534e-8,3.560602e-8,3.574738e-8,3.592426e-8,3.6e-8,3.601868e-8,3.605604e-8,3.613076e-8,3.625977e-8,3.644158e-8,3.664939e-8,3.696056e-8,3.748047e-8,3.828047e-8,3.908047e-8,3.988047e-8,4e-8],"y":[1.8,1.804125,1.808606,1.817899,1.836401,1.868,1.915239,1.814419,0.2247804,0.115078,0.09053167,0.05167891,0.01468168,-0.00094518,0.000252058,-0.000114908,0.00007915409,-0.000065602,0.00006002731,-0.000054797,0.00005040389,-0.0000460022,0.00004232488,-0.0000316357,-0.00346037,-0.00581608,-0.00688758,-0.000657611,-0.000394245,-0.0000784603,0.00001117846,-0.00000500024,0.000003223139,-0.00000256804,0.000002192859,-0.00000183793,0.000001574616,-0.00000106798,0.001411394,0.002722068,0.007575982,0.003624861,-0.00412158,-0.0106354,-0.008616,0.001617267,0.006415319,0.01015315,0.008974191,0.001398645,0.00127481,-0.000106126,0.0005311571,-0.000180003,0.0003466736,-0.000141391,0.00009723361,-0.00412393,-0.00935973,-0.0139336,0.1096546,0.6464399,0.7816522,1.041392,1.408695,1.691252,1.793495,1.800043,1.800056,1.799955,1.800036,1.799948,1.800042,1.799953,1.826067,1.873916,1.93359,1.529313,0.2082889,0.0363558,0.02539257,0.01005596,0.0006950375,-0.000184577,0.0001081767,-0.0000681471,0.00006941152,-0.000053454,0.00005788727,-0.0000449931,0.00004853672,-0.0000377529,0.00002139826,-0.00292584,-0.00529664,-0.00556803,-0.00365164,-0.00277602,-0.00190001,-0.000700877,-0.0000284204,0.000008374305,-0.00000447861,0.000003327853,-0.0000027987,0.00000238818,-0.00000200327,0.000001678766,0.001412489,0.002721858,0.007576053,0.003624818,-0.00411605,-0.0106312,-0.00862876,0.001562815,0.006430251,0.01015842,0.008981038,0.001388179,0.001274302,-0.000108955,0.0005329401,-0.000181731,0.0003480223,-0.000142603,0.00009525357,-0.0047246,-0.0104533,-0.0175366,0.2797491,0.675916,0.8070321,1.058347,1.412792,1.693105,1.793066,1.800062,1.800049,1.799926,1.800056,1.799926,1.800058,1.799939],"name":"V(out)=NaN"}
      x = Array_with_interpolation.new trace[:x]
      y = Array_with_interpolation.new trace[:y]
      delayOUT1 = x.where(y, y: 0.9, rise: 1)
      $stderr.puts "delayOUT1=#{delayOUT1}"
      delayOUT2 = x.where(y, y: 0.9, fall: 2)
      $stderr.puts "delayOUT2=#{delayOUT2}"
      delayOUT3 = x.where(y, y: 0.9, rise: 2)
      $stderr.puts "delayOUT3=#{delayOUT3}"
      assert_equal delayOUT1, 1.6036471772558535e-08
      assert_equal delayOUT2, 2.038103942000604e-08
      assert_equal delayOUT3, 3.603250043302645e-08
    end
end
